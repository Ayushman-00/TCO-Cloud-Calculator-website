
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Cloud TCO Calculator</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="data.js"></script>
    <script src="app.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="logo">Cloud<span>TCO</span></div>
            <div class="menu-label">Saved Scenarios</div>
            <div id="projectList" class="history-list"></div>
            <div style="flex:1"></div>
            <button onclick="logout()" class="btn-logout">Sign Out</button>
        </nav>

        <!-- Main Content -->
        <main class="content">
            <header>
                <h1>Total Cost of Ownership Calculator</h1>
                <div class="actions">
                    <select id="currency" class="currency-select" onchange="changeCurrency()">
                        <option value="USD">$ USD</option>
                        <option value="INR">₹ INR</option>
                    </select>
                    <input type="text" id="projName" placeholder="Scenario name..." class="input-name">
                    <button class="btn-save" onclick="triggerSave()">Save Scenario</button>
                </div>
            </header>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="setTab(0)">Infrastructure Setup</button>
                <button class="tab" onclick="setTab(1)">Environment & Migration</button>
                <button class="tab" onclick="setTab(2)">Financial Analysis</button>
            </div>

            <!-- Tab Content -->
            <div class="input-panel">
                <!-- Tab 1: Infrastructure -->
                <div id="tab-0" class="tab-content active">
                    <h3>Cloud Infrastructure Configuration</h3>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Cloud Region</label>
                            <select id="region"></select>
                            <small class="help-text">Select deployment region (affects pricing)</small>
                        </div>
                        <div class="form-group">
                            <label>Number of Servers/VMs</label>
                            <input type="number" id="count" value="50" min="1" max="10000">
                            <small class="help-text">Total virtual machines to migrate</small>
                        </div>
                        <div class="form-group">
                            <label>Instance Type</label>
                            <select id="instance"></select>
                            <small class="help-text">VM size and specifications</small>
                        </div>
                        <div class="form-group">
                            <label>Storage Type</label>
                            <select id="storageType"></select>
                            <small class="help-text">Performance vs cost tradeoff</small>
                        </div>
                        <div class="form-group">
                            <label>Total Storage (GB)</label>
                            <input type="number" id="storageSize" value="5000" min="0">
                            <small class="help-text">Total data storage needed</small>
                        </div>
                        <div class="form-group">
                            <label>Monthly Egress (GB)</label>
                            <input type="number" id="dataTransfer" value="1000" min="0">
                            <small class="help-text">Data transferred out monthly</small>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Environment & Migration -->
                <div id="tab-1" class="tab-content">
                    <h3>Migration & Datacenter Configuration</h3>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Migration Strategy</label>
                            <select id="migrationType"></select>
                            <small class="help-text">Level of effort and optimization</small>
                        </div>
                        <div class="form-group">
                            <label>Datacenter PUE</label>
                            <input type="number" id="pue" value="1.5" step="0.1" min="1.0" max="3.0">
                            <small class="help-text">Power Usage Effectiveness (1.0 = ideal)</small>
                        </div>
                        <div class="form-group">
                            <label>Analysis Period</label>
                            <select id="duration">
                                <option value="3">3 Years</option>
                                <option value="5" selected>5 Years</option>
                                <option value="7">7 Years</option>
                                <option value="10">10 Years</option>
                            </select>
                            <small class="help-text">Planning horizon</small>
                        </div>
                    </div>
                </div>

                <!-- Tab 3: Financial Analysis -->
                <div id="tab-2" class="tab-content">
                    <h3>Financial Parameters</h3>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Discount Rate (%)</label>
                            <input type="number" id="discountRate" value="8" step="0.5" min="0" max="20">
                            <small class="help-text">For NPV calculation (WACC)</small>
                        </div>
                        <div class="form-group">
                            <label>Display Currency</label>
                            <select id="displayCurrency" onchange="updateDisplayCurrency()">
                                <option value="USD">US Dollar ($)</option>
                                <option value="INR">Indian Rupee (₹)</option>
                            </select>
                            <small class="help-text">All values shown in this currency</small>
                        </div>
                        <div class="form-group">
                            <label>Exchange Rate (INR/USD)</label>
                            <input type="number" id="exchangeRate" value="84.50" step="0.01" min="1">
                            <small class="help-text">Current rate: ₹84.50 per $1</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="results-area">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <h3>Total Savings</h3>
                        <div class="value green" id="disp-savings">$0</div>
                        <small>Over <span id="disp-years">5</span> years</small>
                    </div>
                    <div class="kpi-card">
                        <h3>Return on Investment</h3>
                        <div class="value blue" id="disp-roi">0%</div>
                        <small>Based on cloud investment</small>
                    </div>
                    <div class="kpi-card">
                        <h3>Net Present Value</h3>
                        <div class="value purple" id="disp-npv">$0</div>
                        <small>Discounted cash flows</small>
                    </div>
                    <div class="kpi-card">
                        <h3>Migration Cost</h3>
                        <div class="value orange" id="disp-mig">$0</div>
                        <small>One-time upfront cost</small>
                    </div>
                </div>

                <!-- Chart -->
                <div class="chart-container">
                    <canvas id="tcoChart"></canvas>
                </div>

                <!-- Cost Breakdown -->
                <div class="breakdown-section">
                    <h3>Annual Cost Breakdown</h3>
                    <div class="breakdown-grid">
                        <div class="breakdown-card">
                            <h4>On-Premises (Year 1)</h4>
                            <div class="breakdown-item">
                                <span>Initial CapEx:</span>
                                <span id="bd-capex">$0</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Power:</span>
                                <span id="bd-power">$0</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Cooling:</span>
                                <span id="bd-cooling">$0</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Maintenance:</span>
                                <span id="bd-maint">$0</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Administration:</span>
                                <span id="bd-admin">$0</span>
                            </div>
                        </div>
                        <div class="breakdown-card">
                            <h4>Cloud (Annual)</h4>
                            <div class="breakdown-item">
                                <span>Migration (One-time):</span>
                                <span id="bd-migration">$0</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Compute:</span>
                                <span id="bd-compute">$0</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Storage:</span>
                                <span id="bd-storage">$0</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Network:</span>
                                <span id="bd-network">$0</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Support:</span>
                                <span id="bd-support">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let myChart;
        let currentTab = 0;

        function init() {
            // Populate dropdowns
            const fill = (id, data, valueKey = 'id', labelKey = 'name') => {
                const el = document.getElementById(id);
                el.innerHTML = '';
                data.forEach(d => {
                    const value = d[valueKey] || d;
                    const label = d[labelKey] || d.name;
                    el.innerHTML += `<option value="${value}">${label}</option>`;
                });
            };

            const regionArr = Object.keys(REGIONS).map(k => ({id: k, name: REGIONS[k].name}));
            fill('region', regionArr);
            fill('instance', INSTANCE_CATALOG);
            fill('storageType', STORAGE_TIERS);
            fill('migrationType', MIGRATION_COMPLEXITY);

            // Event listeners
            document.querySelectorAll('input, select').forEach(el => {
                if (el.id !== 'projName' && el.id !== 'currency' && el.id !== 'displayCurrency' && el.id !== 'exchangeRate') {
                    el.addEventListener('change', runAnalysis);
                }
            });

            // Initialize chart
            const ctx = document.getElementById('tcoChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { 
                            label: 'On-Premises (Cumulative)', 
                            data: [], 
                            backgroundColor: 'rgba(100, 116, 139, 0.8)',
                            borderColor: 'rgb(100, 116, 139)',
                            borderWidth: 1
                        },
                        { 
                            label: 'Cloud (Cumulative)', 
                            data: [], 
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });

            checkSession().then(() => {
                loadHistory();
                runAnalysis();
            });
        }

        function getInputs() {
            return {
                region: document.getElementById('region').value,
                count: document.getElementById('count').value,
                instance: document.getElementById('instance').value,
                storageType: document.getElementById('storageType').value,
                storageSize: document.getElementById('storageSize').value,
                dataTransfer: document.getElementById('dataTransfer').value,
                migrationType: document.getElementById('migrationType').value,
                pue: document.getElementById('pue').value,
                duration: document.getElementById('duration').value,
                discountRate: document.getElementById('discountRate').value
            };
        }

        function runAnalysis() {
            const inputs = getInputs();
            const res = calculateEnterpriseTCO(inputs, currentTab);

            // Update KPIs
            document.getElementById('disp-savings').innerText = formatCurrency(res.savings);
            document.getElementById('disp-roi').innerText = res.roi.toFixed(1) + "%";
            document.getElementById('disp-npv').innerText = formatCurrency(res.npv);
            document.getElementById('disp-mig').innerText = formatCurrency(res.migrationCost);
            document.getElementById('disp-years').innerText = inputs.duration;

            // Update breakdown
            document.getElementById('bd-capex').innerText = formatCurrency(res.breakdown.onPrem.capex);
            document.getElementById('bd-power').innerText = formatCurrency(res.breakdown.onPrem.power);
            document.getElementById('bd-cooling').innerText = formatCurrency(res.breakdown.onPrem.cooling);
            document.getElementById('bd-maint').innerText = formatCurrency(res.breakdown.onPrem.maintenance);
            document.getElementById('bd-admin').innerText = formatCurrency(res.breakdown.onPrem.admin);
            
            document.getElementById('bd-migration').innerText = formatCurrency(res.breakdown.cloud.migration);
            document.getElementById('bd-compute').innerText = formatCurrency(res.breakdown.cloud.compute);
            document.getElementById('bd-storage').innerText = formatCurrency(res.breakdown.cloud.storage);
            document.getElementById('bd-network').innerText = formatCurrency(res.breakdown.cloud.network);
            document.getElementById('bd-support').innerText = formatCurrency(res.breakdown.cloud.support);

            // Update chart
            const years = parseInt(inputs.duration);
            myChart.data.labels = Array.from({length: years}, (_, i) => `Year ${i+1}`);
            
            let runningOnPrem = res.breakdown.onPrem.capex;
            let runningCloud = res.migrationCost;
            
            myChart.data.datasets[0].data = res.onPremCashFlow.map(c => {
                runningOnPrem += c;
                return runningOnPrem;
            });
            
            myChart.data.datasets[1].data = res.cloudCashFlow.map(c => {
                runningCloud += c;
                return runningCloud;
            });
            
            myChart.update();
        }

        function setTab(idx) {
            currentTab = idx;
            document.querySelectorAll('.tab').forEach((t, i) => {
                t.classList.toggle('active', i === idx);
            });
            document.querySelectorAll('.tab-content').forEach((c, i) => {
                c.classList.toggle('active', i === idx);
            });
            
            // Recalculate when switching tabs
            runAnalysis();
        }

        function loadState(data) {
            for (const [k, v] of Object.entries(data)) {
                const el = document.getElementById(k);
                if (el) el.value = v;
            }
            runAnalysis();
        }

        function triggerSave() {
            const inputs = getInputs();
            const name = document.getElementById('projName').value;
            saveProject(name, inputs);
        }

        function changeCurrency() {
            currentCurrency = document.getElementById('currency').value;
            runAnalysis();
        }

        function updateDisplayCurrency() {
            const curr = document.getElementById('displayCurrency').value;
            document.getElementById('currency').value = curr;
            changeCurrency();
        }

        window.onload = init;
    </script>
</body>
</html>
